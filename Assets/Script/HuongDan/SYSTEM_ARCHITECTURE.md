# ?? ENEMY BEHAVIOR SYSTEM ARCHITECTURE
## Hierarchical State Machine with Factory Pattern

---

## ?? TOÀN C?NH H? TH?NG

```
????????????????????????????????????????????????????????????????????????
?                    ENEMY BEHAVIOR SYSTEM                             ?
?                  (Hierarchical State Machine)                        ?
????????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????
? LAYER 0: FOUNDATION (H?p ??ng & Interface)                         ?
???????????????????????????????????????????????????????????????????????
?                                                                     ?
?  ???????????????????????    ????????????????????????????          ?
?  ?  IEnemyState        ?    ? IEnemyStateProvider      ?          ?
?  ?  (Interface)        ?    ? (Factory Interface)      ?          ?
?  ???????????????????????    ????????????????????????????          ?
?  ? + OnEnter()         ?    ? + GetChaseState()        ?          ?
?  ? + OnUpdate()        ?    ? + GetAttackState()       ?          ?
?  ? + OnExit()          ?    ????????????????????????????          ?
?  ???????????????????????                                           ?
?        ? implement            ? implement                          ?
?        ?                      ?                                    ?
???????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????
? LAYER 1: BASE STATES (Tái s? d?ng logic chung)                     ?
???????????????????????????????????????????????????????????????????????
?                                                                     ?
?  ??????????????????????????      ???????????????????????????      ?
?  ? BaseChaseState         ?      ? BaseAttackState         ?      ?
?  ? (Abstract)             ?      ? (Abstract)              ?      ?
?  ??????????????????????????      ???????????????????????????      ?
?  ? OnEnter() {            ?      ? OnEnter() {             ?      ?
?  ?   SetBool("Run", true) ?      ?   SetBool("Run", false) ?      ?
?  ? }                      ?      ?   LookAtPlayer()        ?      ?
?  ?                        ?      ? }                       ?      ?
?  ? OnUpdate() {           ?      ?                         ?      ?
?  ?   // Ki?m tra range    ?      ? OnUpdate() {            ?      ?
?  ?   if (dist > attack)   ?      ?   // Ki?m tra range     ?      ?
?  ?     ? GetAttackState() ?      ?   if (dist > attack)    ?      ?
?  ?                        ?      ?     ? GetChaseState()   ?      ?
?  ?   if (dist > vision)   ?      ?                         ?      ?
?  ?     ? PatrolState()    ?      ?   if (dist > vision)    ?      ?
?  ?                        ?      ?     ? PatrolState()     ?      ?
?  ?   ExecuteChase()       ?      ?                         ?      ?
?  ?   ? Abstract method    ?      ?   ExecuteAttackPattern()?      ?
?  ? }                      ?      ?   ? Abstract method     ?      ?
?  ?                        ?      ? }                       ?      ?
?  ??????????????????????????      ???????????????????????????      ?
?        ? extend                            ? extend                 ?
?        ?                                   ?                       ?
???????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????
? LAYER 2: CONCRETE STATES (Implement logic riêng)                   ?
???????????????????????????????????????????????????????????????????????
?                                                                     ?
?  CHASE STATES:                    ATTACK STATES:                   ?
?  ???????????????                  ????????????????                 ?
?                                                                     ?
?  ???????????????????              ????????????????????            ?
?  ? ChaseState      ?              ? AttackState      ?            ?
?  ? (Generic)       ?              ? (Generic)        ?            ?
?  ???????????????????              ????????????????????            ?
?  ? ExecuteChase(): ?              ? ExecuteAttack(): ?            ?
?  ? - MoveTowardP() ?              ? - ExecuteAttack()?            ?
?  ? - LookAtPlayer()?              ? - Simple 1 type  ?            ?
?  ???????????????????              ????????????????????            ?
?                                                                     ?
?  ????????????????????????         ???????????????????????         ?
?  ? GolemChaseState      ?         ? SlimeAttackState    ?         ?
?  ? (Golem Special)      ?         ? (Slime Special)     ?         ?
?  ????????????????????????         ???????????????????????         ?
?  ? ExecuteChase():      ?         ? ExecuteAttack():    ?         ?
?  ? - Check skill[0]?    ?         ? - Xen k?:          ?         ?
?  ? - N?u có: Cast skill ?         ?   Hit ? Attack     ?         ?
?  ? - N?u không: Chase   ?         ? - Toggle logic     ?         ?
?  ????????????????????????         ???????????????????????         ?
?                                                                     ?
?                                    ???????????????????????         ?
?                                    ? GolemAttackState    ?         ?
?                                    ? (Golem Special)     ?         |
?                                    ???????????????????????         ?
?                                    ? ExecuteAttack():    ?         ?
?                                    ? - Priority 1:       ?         ?
?                                    ?   skill[1]?         ?         ?
?                                    ? - Priority 2:       ?         ?
?                                    ?   Xen k? Attack+1   ?         ?
?                                    ? - Support Phase2    ?         ?
?                                    ???????????????????????         ?
?                                                                     ?
???????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????
? LAYER 3: STATE MACHINE CONTROLLER (Qu?n lý state)                  ?
???????????????????????????????????????????????????????????????????????
?                                                                     ?
?  ????????????????????????????????????????????????????????????     ?
?  ? EnemyController : MonoBehaviour, IEnemyStateProvider     ?     ?
?  ????????????????????????????????????????????????????????????     ?
?  ? Attributes:                                              ?     ?
?  ? - currentState: IEnemyState                              ?     ?
?  ? - speed, attackRange, visionRange, etc.                  ?     ?
?  ?                                                          ?     ?
?  ? Methods:                                                 ?     ?
?  ? + Start(): ChangeState(new PatrolState())               ?     ?
?  ? + Update(): currentState?.OnUpdate(this)                ?     ?
?  ? + ChangeState(newState): exit old, enter new            ?     ?
?  ?                                                          ?     ?
?  ? Factory Methods:                                         ?     ?
?  ? + GetChaseState(): virtual ? return ChaseState()        ?     ?
?  ? + GetAttackState(): virtual ? return AttackState()      ?     ?
?  ?                                                          ?     ?
?  ? Behavior Methods:                                        ?     ?
?  ? + Patrol(), LookAtPlayer(), MoveTowardPlayer()          ?     ?
?  ? + ExecuteAttack(), DealNormalAttackDamage()             ?     ?
?  ?                                                          ?     ?
?  ? Getters/Setters:                                         ?     ?
?  ? + GetDistanceToPlayer(), GetAttackRange()               ?     ?
?  ? + GetLastTimeAttack(), SetLastTimeAttack()              ?     ?
?  ????????????????????????????????????????????????????????????     ?
?        ? extend                                                    ?
?        ?                                                          ?
???????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????
? LAYER 4: ENEMY CLASSES (??nh ngh?a behavior)                       ?
???????????????????????????????????????????????????????????????????????
?                                                                     ?
?  ????????????????????  ????????????????????  ???????????????????? ?
?  ? SkullE           ?  ? SlimeE           ?  ? GolemE           ? ?
?  ????????????????????  ????????????????????  ???????????????????? ?
?  ? // Default       ?  ? // Override      ?  ? // Override      ? ?
?  ? // Không c?n     ?  ? // Ch? Attack    ?  ? // C? Chase+Atk  ? ?
?  ? // override      ?  ? // khác          ?  ?                  ? ?
?  ?                  ?  ?                  ?  ? skillManager     ? ?
?  ?                  ?  ? GetAttackState() ?  ? isPhase2         ? ?
?  ?                  ?  ? {                ?  ?                  ? ?
?  ?                  ?  ?   return new     ?  ? GetChaseState()  ? ?
?  ?                  ?  ?   Slime          ?  ? {                ? ?
?  ?                  ?  ?   AttackState()  ?  ?   return new     ? ?
?  ?                  ?  ? }                ?  ?   GolemChase()   ? ?
?  ?                  ?  ?                  ?  ? }                ? ?
?  ?                  ?  ?                  ?  ?                  ? ?
?  ?                  ?  ?                  ?  ? GetAttackState() ? ?
?  ?                  ?  ?                  ?  ? {                ? ?
?  ?                  ?  ?                  ?  ?   return new     ? ?
?  ?                  ?  ?                  ?  ?   GolemAttack()  ? ?
?  ?                  ?  ?                  ?  ? }                ? ?
?  ?                  ?  ?                  ?  ?                  ? ?
?  ?                  ?  ?                  ?  ? Attack1(), Cast()? ?
?  ????????????????????  ????????????????????  ???????????????????? ?
?                                                                     ?
???????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????
? LAYER 5: GLOBAL STATES (Dùng chung)                                ?
???????????????????????????????????????????????????????????????????????
?                                                                     ?
?  ????????????????????????????????????????????????????????????     ?
?  ? PatrolState : IEnemyState                                ?     ?
?  ????????????????????????????????????????????????????????????     ?
?  ? OnEnter(): SetBool("Run", false)                         ?     ?
?  ? OnUpdate():                                              ?     ?
?  ?   - if (dist < vision): GetChaseState()                 ?     ?
?  ?   - else: Patrol()                                       ?     ?
?  ? OnExit():                                                ?     ?
?  ????????????????????????????????????????????????????????????     ?
?                                                                     ?
???????????????????????????????????????????????????????????????????????
```

---

## ?? STATE TRANSITION DIAGRAMS

### **SKULL (C? b?n - s? d?ng default states)**

```
          ????????????????????????????????????????
          ?         START                        ?
          ????????????????????????????????????????
                         ?
                         ?
          ????????????????????????????????????????
          ?    PatrolState.OnEnter()             ?
          ?    ?? SetBool("Run", false)          ?
          ????????????????????????????????????????
                         ?
                         ?
          ????????????????????????????????????????
    ???????    PatrolState.OnUpdate()            ???????????
    ?     ?    - Patrol()                        ?         ?
    ?     ?    - Check distance < visionRange?   ?         ?
    ?     ????????????????????????????????????????         ?
    ?                    ?                                  ?
    ?                    ? distance < visionRange          ?
    ?                    ?                                  ?
    ?     ????????????????????????????????????????         ?
    ?     ?   ChaseState.OnEnter()               ?         ?
    ?     ?   ?? SetBool("Run", true)            ?         ?
    ?     ????????????????????????????????????????         ?
    ?                    ?                                  ?
    ?                    ?                                  ?
    ?     ????????????????????????????????????????         ?
    ???????   ChaseState.OnUpdate()              ?         ?
    NO    ?   - MoveTowardPlayer()               ?         ?
    dist  ?   - Check distance?                  ???????????
    >vis  ?? if distance > visionRange           ?    ?
    ?   ?? PatrolState() ??????????????????    ?
    ?                    ?                                  ?
    ?          ?????????????????         distance <= attackRange
    ?          ?               ?                  ?
    ?    cooldown        cooldown        ????????????????????????????????????????
    ?    not ready       not ready       ?   AttackState.OnEnter()              ?
    ?                                      ?   ?? SetBool("Run", false)           ?
    ?                                      ?   ?? LookAtPlayer()                  ?
    ?                                      ????????????????????????????????????????
    ?                                                     ?
    ?                                                     ?
    ?                                       ????????????????????????????????????????
    ?                                       ?   AttackState.OnUpdate()             ?
    ?                                       ?   - ExecuteAttack()                  ?
    ?                                       ?   - Check distance?                  ?
    ?? if distance > attackRange           ?        ?
    ?   ?? ChaseState() ????????????????????        ?
    ?                                      ?        ?
    ? - if distance > visionRange          ?        ?
    ?   ?? PatrolState() ????????????????????????????
    ????????????????????????????????????????
```

### **SLIME (Attack khác - xen k? Hit + Attack)**

```
    PatrolState ??????????????? ChaseState
         ?                           ?
         ?                           ? (default - MoveTowardPlayer)
         ? distance > visionRange    ?
         ?????????????????????????????
                                     ?
                                     ? distance <= attackRange
                                     ?
                          ??????????????????????????????
                          ? SlimeAttackState.OnEnter() ?
                          ? - SetBool("Run", false)    ?
                          ? - LookAtPlayer()           ?
                          ? - checkAttack = false      ?
                          ??????????????????????????????
                                   ?
                                   ?
                          ??????????????????????????????
        ??????????????????? ExecuteAttackPattern()     ????????
        ?                 ? - if !checkAttack:         ?      ?
        ?                 ?   SetTrigger("Hit")        ?      ?
        ? checkAttack     ?   checkAttack = true       ?      ?
        ? = false         ?                            ?      ?
        ?                 ? - else:                    ?      ?
        ?                 ?   SetTrigger("Attack")     ?      ?
        ?                 ?   checkAttack = false      ?      ?
        ?                 ??????????????????????????????      ?
        ?                          ?                         ?
        ?          ?????????????????????????????????         ?
        ?          ?               ?               ?         ?
        ?    cooldown        cooldown        cooldown        ?
        ?    not ready       not ready       not ready        ?
        ?                                                     ?
        ?                    distance > attackRange          ?
        ?                    or distance > visionRange        ?
        ???????????????????????????????????????????????????????
                         (ChaseState or PatrolState)
```

### **GOLEM (Chase + Attack khác - có skill)**

```
    PatrolState ??????????????????????????????
         ?      ? distance < visionRange     ?
         ?      ?                            ?
         ?      ?                            ?
         ?  ???????????????????????????     ?
         ?  ? GolemChaseState.Exec()  ?     ?
         ?  ?? if skill[0].Ready?     ?     ?
         ?  ?   SetTrigger("Attack2") ?     ?
         ?  ?   CastGolemMagic()      ?     ? distance > vision
         ?  ?   return                ?     ?
         ?  ? else:                   ?     ?
         ?  ?   MoveTowardPlayer()    ???????
         ?  ???????????????????????????
         ?                ?
         ? distance >     ? distance <= attackRange
         ? attackRange    ?
         ?    ????????????????????????????????????
         ?    ? GolemAttackState.OnEnter()       ?
         ?    ? - SetBool("Run", false)          ?
         ?    ? - LookAtPlayer()                 ?
         ?    ? - checkAttack1 = false           ?
         ?    ????????????????????????????????????
         ?                   ?
         ?                   ?
         ?    ????????????????????????????????????
         ?    ? ExecuteAttackPattern()           ?
         ?    ?                                  ?
         ?    ? Priority 1:                      ?
         ?    ? if skill[1].Ready?               ?
         ?    ?   SetTrigger("Attack3")          ?
         ?    ?   CastStoneSpike()               ?
         ?    ?   return                         ?
         ?    ?                                  ?
         ?    ? Priority 2 (xen k?):            ?
         ?    ? if checkAttack1:                 ?
         ?    ?   SetTrigger("Attack")           ?
         ?    ?   checkAttack1 = false           ?
         ?    ? else:                            ?
         ?    ?   Attack1()                      ?
         ?    ?   checkAttack1 = true            ?
         ?    ????????????????????????????????????
         ?                   ?
         ?????????????????????
              (khi ra kh?i range)
```

---

## ?? FILE STRUCTURE

```
Assets/Script/EnemyThing/
??? IEnemyState.cs                 ???? Interface (H?p ??ng)
??? IEnemyStateProvider.cs         ???? Factory Interface
??? EnemyController.cs             ???? State Machine Controller
?
??? State/
?   ??? BaseChaseState.cs          ???? Base class (tái s? d?ng)
?   ??? BaseAttackState.cs         ???? Base class (tái s? d?ng)
?   ??? PatrolState.cs             ???? Global state (s? d?ng chung)
?   ?
?   ??? ChaseState.cs              ???? Generic (cho Skull/Slime)
?   ??? GolemChaseState.cs         ???? Special (ch? Golem)
?   ?
?   ??? AttackState.cs             ???? Generic (cho Skull)
?   ??? SlimeAttackState.cs        ???? Special (ch? Slime)
?   ??? GolemAttackState.cs        ???? Special (ch? Golem)
?   ?
?   ??? SleepState.cs              ???? Custom (ch? DreamEnemy ho?c t??ng t?)
?   ??? WakeUpState.cs             ???? Custom (ch? DreamEnemy ho?c t??ng t?)
?   ??? ...
?
??? SkullE.cs                      ???? Enemy (dùng default)
??? SlimeE.cs                      ???? Enemy (override Attack)
??? GolemE.cs                      ???? Enemy (override Chase + Attack)
??? DreamEnemyE.cs                 ???? Enemy (custom Sleep + WakeUp)
```

---

## ?? KEY CONCEPTS

### **1. Factory Pattern**
```
Thay vì:
  if (enemy is SlimeE) return new SlimeAttackState()
  else return new AttackState()

Làm:
  enemy.GetAttackState()  ???? Enemy t? nói state mình c?n
```

### **2. Template Method Pattern (trong BaseAttackState)**
```
BaseAttackState ??nh ngh?a skeleton:
- OnUpdate() checks range (CHUNG)
- G?i ExecuteAttackPattern() (ABSTRACT - subclass implement)

AttackState ch? c?n implement:
- ExecuteAttackPattern() { enemy.ExecuteAttack(); }
```

### **3. Polymorphism**
```
EnemyController.GetAttackState(): virtual
?? SkullE: không override (dùng default AttackState)
?? SlimeE: override ? return new SlimeAttackState()
?? GolemE: override ? return new GolemAttackState()
```

### **4. Open/Closed Principle**
```
? Open for extension: Thêm enemy m?i = t?o class + override
? Closed for modification: Không s?a ChaseState hay code c?
```

---

## ?? BEHAVIOR MATRIX

| Enemy | Chase Logic | Attack Logic | Status |
|-------|-------------|--------------|--------|
| **Skull** | Default (move) | Default (1 attack) | ? Simple |
| **Slime** | Default (move) | Custom (Hit + Attack) | ?? Attack khác |
| **Golem** | Custom (skill cast) | Custom (skill + multi) | ?? Complex |
| **Future Enemy A** | Custom? | Custom? | ? Extensible |

---

## ?? ADVANTAGES

? **Zero If/Else Type Checking** - ChaseState không c?n bi?t lo?i enemy
? **Scalable** - Thêm enemy m?i = 1 class + override method
? **Maintainable** - M?i state là file riêng, easy to debug
? **Reusable** - BaseChaseState, BaseAttackState tái s? d?ng
? **Testable** - Mock `GetAttackState()` d? dàng
? **Flexible** - Enemy có th? có state ??c ?áo (Sleep, Stun, v.v)

---

## ? FLOW SUMMARY

```
1. Start() ? ChangeState(new PatrolState())
   ?
2. Update() ? currentState.OnUpdate(this)
   ?
3. PatrolState.OnUpdate()
   ?
   ?? distance < visionRange?
   ?  ?? GetChaseState() ? SkullE returns ChaseState
   ?                    ? SlimeE returns ChaseState (default)
   ?                    ? GolemE returns GolemChaseState
   ?                    ? DreamEnemyE returns WakeUpState
   ?
4. ChaseState/GolemChaseState/WakeUpState.OnUpdate()
   ?
   ?? distance <= attackRange?
   ?  ?? GetAttackState() ? SkullE returns AttackState
   ?                     ? SlimeE returns SlimeAttackState
   ?                     ? GolemE returns GolemAttackState
   ?                     ? DreamEnemyE returns AttackState
   ?
5. AttackState/SlimeAttackState/GolemAttackState.OnUpdate()
   ?
   ?? distance > attackRange?
   ?  ?? GetChaseState() ? quay l?i chase
   ?
   ?? distance > visionRange?
   ?  ?? GetPatrolState() ? quay l?i patrol (ho?c SleepState)
   ?
   ?? (N?u ra kh?i vision range)
      ?? GetPatrolState() ? DreamEnemyE returns SleepState
                         ? Skull/Slime/Golem returns PatrolState

---

## ?? EXTENDED FLOW: PATROL STATE (Chi ti?t h?n)

```
          ?????????????????????????????????????????
          ?     PatrolState.OnUpdate()            ?
          ?  (M?c ??nh cho t?t c? enemy)          ?
          ?????????????????????????????????????????
                      ?
    ??????????????????????????????????????
    ?                                    ?
    ? distance < visionRange?            ?
    ?                                    ?
    YES                                  NO
    ?                                    ?
    ?                                    ?
???????????????????????????     ????????????????????????
? GetChaseState()         ?     ? Patrol()             ?
? ?? SkullE: Chase        ?     ? ?? move left/right  ?
? ?? SlimeE: Chase        ?     ? ?? flip direction   ?
? ?? GolemE: GolemChase   ?     ? ?? check obstacles  ?
? ?? DreamEnemy: WakeUp   ?     ????????????????????????
???????????????????????????     (ti?p t?c loop)
```

---

## ?? CUSTOM STATE: SLEEP EXAMPLE (DreamEnemy)

### **Problem: M?t enemy khác v?i quy t?c chu?n**

```
Skull/Slime/Golem:
  Patrol ? Chase ? Attack ? (if far) Patrol

DreamEnemy (Ví d?):
  Sleep ? (khi player g?n) WakeUp ? Chase ? Attack ? (if far) Sleep
  
? Problem: DreamEnemy không có Patrol state!
? Solution: Override GetPatrolState() ?? return SleepState
```

### **Architecture: Sleep/WakeUp States**

```
???????????????????????????????????????????????????????????
? CUSTOM STATES FOR UNIQUE ENEMIES                        ?
???????????????????????????????????????????????????????????
?                                                         ?
?  ????????????????????????      ?????????????????????? ?
?  ? SleepState           ?      ? WakeUpState        ? ?
?  ? (Custom - DreamEnemy)?      ? (Custom - Dream)   ? ?
?  ????????????????????????      ?????????????????????? ?
?  ? OnEnter() {          ?      ? OnEnter() {        ? ?
?  ?   - Play sleep anim  ?      ?   - Play wakeup anim?
?  ?   - Velocity = 0     ?      ?   - Look at player ? ?
?  ? }                    ?      ? }                  ? ?
?  ?                      ?      ?                    ? ?
?  ? OnUpdate() {         ?      ? OnUpdate() {       ? ?
?  ?   if (dist <         ?      ?   if (dist >       ? ?
?  ?      visionRange) {  ?      ?      visionRange) {? ?
?  ?     GetChaseState()  ?      ?     GetPatrol      ? ?
?  ?   }                  ?      ?     State()        ? ?
?  ? }                    ?      ?   } else {         ? ?
?  ????????????????????????      ?     GetChaseState()?
?                                ?   }                ?
?                                ? }                  ?
?                                ??????????????????????
?                                                         ?
???????????????????????????????????????????????????????????
```

---

## ?? GI?I PHÁP: Factory Methods cho Custom Behavior

### **Hi?n t?i:**

```csharp
// EnemyController (base)
public virtual IEnemyState GetChaseState() 
{
    return new ChaseState();
}

public virtual IEnemyState GetAttackState() 
{
    return new AttackState();
}
```

### **C?n thêm:**

```csharp
// EnemyController (base)
public virtual IEnemyState GetPatrolState() 
{
    return new PatrolState();  // Default patrol
}
```

### **DreamEnemy Override:**

```csharp
public class DreamEnemyE : EnemyController
{
    // Chase: quay l?i Sleep thay vì Patrol
    public override IEnemyState GetPatrolState()
    {
        return new SleepState();  // Sleep thay vì Patrol!
    }

    public override IEnemyState GetChaseState()
    {
        return new WakeUpState();  // WakeUp thay vì Chase!
    }

    // Attack: có th? dùng default ho?c custom
    // public override IEnemyState GetAttackState() { ... }
}
```

---

## ?? FULL COMPARISON: 3 LO?I ENEMY

```
???????????????????????????????????????????????????????????????
?                    SKULL (Simple)                           ?
???????????????????????????????????????????????????????????????
? Patrol (default)                                            ?
?   ? dist < vision                                           ?
?   ? Chase (default)                                         ?
?      ? dist <= attack                                       ?
?      ? Attack (default)                                     ?
?         ? dist > attack ? Chase                             ?
?         ? dist > vision ? Patrol (default) ????????        ?
???????????????????????????????????????????????????????????????
                                                    ?
???????????????????????????????????????????????????????????????
?                    GOLEM (Complex)                          ?
???????????????????????????????????????????????????????????????
? Patrol (default)                                            ?
?   ? dist < vision                                           ?
?   ? GolemChase (custom - có skill) ???????                ?
?      ? dist <= attack                    ?                 ?
?      ? GolemAttack (custom - skill+multi)?                 ?
?         ? dist > attack ? GolemChase ?????                 ?
?         ? dist > vision ? Patrol (def) ???                 ?
???????????????????????????????????????????????????????????????
                                            ?
???????????????????????????????????????????????????????????????
?               DREAM ENEMY (Unique Behavior)                 ?
???????????????????????????????????????????????????????????????
? Sleep (custom - thay PatrolState!)                          ?
?   ? dist < vision                                           ?
?   ? WakeUp (custom - thay ChaseState!) ????               ?
?      ? dist <= attack                      ?               ?
?      ? Attack (default ho?c custom)        ?               ?
?         ? dist > attack ? WakeUp ???????????               ?
?         ? dist > vision ? Sleep (custom) ???               ?
?                       (thay vì Patrol!)                     ?
???????????????????????????????????????????????????????????????
```

---

## ? **CÓ, H? TH?NG NÀY HOÀN TOÀN GI?I QUY?T ???C!**

### **T?i sao?**

**1. Virtual Factory Methods:**
```csharp
public virtual IEnemyState GetPatrolState() { return new PatrolState(); }
public virtual IEnemyState GetChaseState() { return new ChaseState(); }
public virtual IEnemyState GetAttackState() { return new AttackState(); }
```

**2. Enemy Override tùy ý:**
```csharp
// DreamEnemy không c?n Patrol
public override IEnemyState GetPatrolState()
{
    return new SleepState();  // ? Thay th? hoàn toàn!
}

public override IEnemyState GetChaseState()
{
    return new WakeUpState();  // ? Custom chase behavior
}
```

**3. Các State g?i factory methods:**
```csharp
// WakeUpState.OnUpdate()
public void OnUpdate(EnemyController enemy)
{
    if (enemy.GetDistanceToPlayer() > enemy.GetVisionRange())
    {
        enemy.ChangeState(enemy.GetPatrolState());  // ? G?i factory
    }
}
```

**K?t qu?:**
- ? DreamEnemy không bao gi? vào PatrolState
- ? Thay vào ?ó: Sleep ? WakeUp ? Attack
- ? Không c?n if/else type checking
- ? M?i enemy ??nh ngh?a behavior riêng

---

## ?? UPDATED CHECKLIST

### Phase 1: Interfaces & Base Classes
- [ ] Create `IEnemyStateProvider.cs`
- [ ] Create `BaseChaseState.cs`
- [ ] Create `BaseAttackState.cs`

### Phase 2: Base Factory Methods
- [ ] Add `GetPatrolState(): virtual` to EnemyController
- [ ] Add `GetChaseState(): virtual` to EnemyController
- [ ] Add `GetAttackState(): virtual` to EnemyController

### Phase 3: Concrete Chase States
- [ ] Refactor `ChaseState.cs`
- [ ] Create `GolemChaseState.cs`
- [ ] Create `WakeUpState.cs` (cho DreamEnemy)

### Phase 4: Concrete Attack States
- [ ] Refactor `AttackState.cs`
- [ ] Already have `SlimeAttackState.cs`
- [ ] Create `GolemAttackState.cs`

### Phase 5: Custom States (n?u c?n)
- [ ] Create `SleepState.cs` (thay PatrolState)
- [ ] Update `PatrolState.cs` s? d?ng GetPatrolState()

### Phase 6: Update Enemy Classes
- [ ] `SkullE.cs` - no override
- [ ] `SlimeE.cs` - override GetAttackState()
- [ ] `GolemE.cs` - override GetChaseState() + GetAttackState()
- [ ] `DreamEnemyE.cs` - override GetPatrolState() + GetChaseState()

### Phase 7: Testing
- [ ] Skull: Patrol ? Chase ? Attack
- [ ] Slime: Patrol ? Chase ? Attack (xen k?)
- [ ] Golem: Patrol ? Chase (skill) ? Attack (skill+multi)
- [ ] DreamEnemy: Sleep ? WakeUp ? Attack ? Sleep

---

## ?? SUMMARY: T?I SAO SYSTEM NÀY LINH HO?T?

```
TRUY?N TH?NG (C?ng nh?c):
  if (enemy.GetType() == typeof(Skull)) return Patrol;
  else if (enemy.GetType() == typeof(Dream)) return Sleep;
  else return Patrol;

FACTORY PATTERN (Linh ho?t):
  return enemy.GetPatrolState();  ???? Enemy t? quy?t ??nh!
```

B?n có th?:
- ? Thêm custom state mà không s?a code c?
- ? Enemy có th? skip Patrol hoàn toàn
- ? Enemy có th? có state ph?c t?p tùy ý
- ? Không c?n if/else type checking
- ? Open/Closed Principle: open for extension, closed for modification

